<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î®Ï‚ ÎŸÎ¼Î¿Î»ÏŒÎ³Ï‰Î½ Pro</title>
    
    <!-- Favicon Î¼Îµ emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“Š</text></svg>">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            font-family: 'Segoe UI', Arial; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            color: white;
        }

        .logo {
            font-size: 4rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle { 
            font-size: 1.1rem; 
            opacity: 0.9; 
        }

        .card { 
            background: white; 
            border-radius: 16px; 
            padding: 30px; 
            margin: 20px 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .card h2 { 
            color: #1a237e; 
            border-bottom: 3px solid #667eea; 
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .form-row { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px;
        }

        label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #37474f; 
        }

        input, select { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid #e0e0e0; 
            border-radius: 8px; 
            font-size: 16px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            padding: 15px 50px; 
            font-size: 18px; 
            font-weight: 600;
            border-radius: 8px; 
            cursor: pointer;
            display: block;
            margin: 30px auto;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .results { display: none; }
        .results.show { display: block; }

        .result-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 15px; 
            background: #f5f7fa; 
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .result-row.highlight {
            background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
            border-left: 4px solid #ff6f00;
        }

        .result-row.total {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-left: 4px solid #28a745;
            font-weight: bold;
        }

        .result-label { font-weight: 600; color: #37474f; }

        .result-value { 
            font-weight: 700; 
            color: #1a237e; 
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
        }

        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
            font-size: 0.95rem;
        }

        th { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 12px; 
            text-align: left;
            font-weight: 600;
        }

        td { 
            padding: 12px; 
            border-bottom: 1px solid #e0e0e0; 
        }

        tr:hover { background: #f5f7fa; }

        .verification {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 20px;
        }

        .btn-export {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            margin-top: 20px;
        }

        .info {
            background: #e3f2fd;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 20px;
        }

        .summary-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin: 20px 0;
        }

        .summary-box h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .logo { font-size: 3rem; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">ğŸ“Š</div>
            <h1>Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÏ„Î®Ï‚ ÎŸÎ¼Î¿Î»ÏŒÎ³Ï‰Î½ Pro</h1>
            <p class="subtitle">Î¥Ï€Î¿Î»Î¿Î³Î¯ÏƒÏ„Îµ YTM, Ï€ÏÎ¿Ï€Î»Î·ÏÏ‰Î¼Î­Î½Î¿ ÎºÎ¿Ï…Ï€ÏŒÎ½Î¹ ÎºÎ±Î¹ Ï„Î±Î¼ÎµÎ¹Î±ÎºÎ­Ï‚ ÏÎ¿Î­Ï‚</p>
        </header>
        
        <div class="info">
            ğŸ’¡ Î Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³Î®ÏƒÏ„Îµ Ï„Î¿Ï…Ï‚ Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚ ÎºÎ±Î¹ Î¸Î± Î¼Î¿ÏÏ†Î¿Ï€Î¿Î¹Î·Î¸Î¿ÏÎ½ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± (Ï€.Ï‡. 4000000 â†’ 4.000.000,00)
        </div>

        <div class="card">
            <h2>ğŸ“‹ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± ÎŸÎ¼Î¿Î»ÏŒÎ³Î¿Ï…</h2>
            <div class="form-row">
                <div>
                    <label>Nominal Value / ÎŸÎ½Î¿Î¼Î±ÏƒÏ„Î¹ÎºÎ® Î‘Î¾Î¯Î± *</label>
                    <input type="text" id="fv" class="num-input" placeholder="4.000.000,00">
                </div>
                <div>
                    <label>Market Value / Clean Price *</label>
                    <input type="text" id="mv" class="num-input" placeholder="3.991.320,00">
                </div>
                <div>
                    <label>Coupon Rate (%) / Î•Ï€Î¹Ï„ÏŒÎºÎ¹Î¿ ÎšÎ¿Ï…Ï€Î¿Î½Î¹Î¿Ï (%) *</label>
                    <input type="text" id="cr" placeholder="5,033302">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Issue Day / Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÎˆÎºÎ´Î¿ÏƒÎ·Ï‚ *</label>
                    <input type="date" id="id">
                </div>
                <div>
                    <label>Value Day / Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î‘Î³Î¿ÏÎ¬Ï‚ *</label>
                    <input type="date" id="vd">
                </div>
                <div>
                    <label>Maturity Day / Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î›Î®Î¾Î·Ï‚ *</label>
                    <input type="date" id="md">
                </div>
            </div>
            <div class="form-row">
                <div>
                    <label>Î£Ï…Ï‡Î½ÏŒÏ„Î·Ï„Î± Î Î»Î·ÏÏ‰Î¼ÏÎ½ / Payment Frequency *</label>
                    <select id="fr">
                        <option value="12">Î•Ï„Î®ÏƒÎ¹Î± (12 Î¼Î®Î½ÎµÏ‚)</option>
                        <option value="6">Î•Î¾Î±Î¼Î·Î½Î¹Î±Î¯Î± (6 Î¼Î®Î½ÎµÏ‚)</option>
                        <option value="4">Î¤ÎµÏ„ÏÎ±Î¼Î·Î½Î¹Î±Î¯Î± (4 Î¼Î®Î½ÎµÏ‚)</option>
                        <option value="3">Î¤ÏÎ¹Î¼Î·Î½Î¹Î±Î¯Î± (3 Î¼Î®Î½ÎµÏ‚)</option>
                        <option value="1">ÎœÎ·Î½Î¹Î±Î¯Î± (1 Î¼Î®Î½Î±)</option>
                    </select>
                </div>
                <div>
                    <label>Î’Î¬ÏƒÎ· Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï Î—Î¼ÎµÏÏÎ½ / Day Count Basis *</label>
                    <select id="db">
                        <option value="365">365</option>
                        <option value="360">360</option>
                    </select>
                </div>
            </div>
            <button onclick="calculate()">ğŸ” Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚</button>
        </div>

        <div id="res" class="card results">
            <h2>ğŸ“ˆ Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±</h2>
            
            <div class="result-row highlight">
                <span class="result-label">YTM (Yield to Maturity)</span>
                <span id="r-ytm" class="result-value">-</span>
            </div>
            <div class="result-row">
                <span class="result-label">Î ÏÎ¿Ï€Î»Î·ÏÏ‰Î¼Î­Î½Î¿ ÎšÎ¿Ï…Ï€ÏŒÎ½Î¹ / Accrued interest </span>
                <span id="r-acc" class="result-value">-</span>
            </div>
            <div class="result-row">
                <span class="result-label">ÎœÎ¹ÎºÏ„Î® Î¤Î¹Î¼Î® (Dirty Price) / Dirty Price </span>
                <span id="r-dirty" class="result-value">-</span>
            </div>
            <div class="result-row">
                <span class="result-label">Î—Î¼Î­ÏÎµÏ‚ Accrued / Accrued Days </span>
                <span id="r-days" class="result-value">-</span>
            </div>
            <div class="result-row">
                <span class="result-label">Î•Ï„Î®ÏƒÎ¹Î¿ ÎšÎ¿Ï…Ï€ÏŒÎ½Î¹ / Annual Coupon </span>
                <span id="r-ann" class="result-value">-</span>
            </div>
            <!-- ÎÎ•ÎŸ: Î”Î¹Î¬ÏÎºÎµÎ¹Î± Î¿Î¼Î¿Î»ÏŒÎ³Î¿Ï… -->
            <div class="result-row">
                <span class="result-label">Î”Î¹Î¬ÏÎºÎµÎ¹Î± ÎŸÎ¼Î¿Î»ÏŒÎ³Î¿Ï… (Î‘Î³Î¿ÏÎ¬ â†’ Î›Î®Î¾Î·) / Bond Duration </span>
                <span id="r-duration" class="result-value">-</span>
            </div>

            <!-- Î£Î¥ÎÎŸÎ›Î‘ -->
            <div class="summary-box">
                <h3>ğŸ“Š Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ Î¤Î±Î¼ÎµÎ¹Î±ÎºÎ­Ï‚ Î¡Î¿Î­Ï‚</h3>
                <div class="result-row">
                    <span class="result-label">Î£ÏÎ½Î¿Î»Î¿ ÎšÎ¿Ï…Ï€Î¿Î½Î¹ÏÎ½ / Total Coupons </span>
                    <span id="r-tot-coup" class="result-value">-</span>
                </div>
                <div class="result-row">
                    <span class="result-label">ÎšÎµÏ†Î¬Î»Î±Î¹Î¿ Î›Î®Î¾Î·Ï‚ / Principal Repayment </span>
                    <span id="r-cap" class="result-value">-</span>
                </div>
                <div class="result-row total">
                    <span class="result-label">Î£Î¥ÎÎŸÎ›Î™ÎšÎ•Î£ Î•Î™Î£Î Î¡Î‘ÎÎ•Î™Î£ / Total Cash Flows </span>
                    <span id="r-tot-all" class="result-value">-</span>
                </div>
                <div class="result-row">
                    <span class="result-label">ÎœÎ¹ÎºÏ„Î® Î¤Î¹Î¼Î® (ÎšÏŒÏƒÏ„Î¿Ï‚ Î‘Î³Î¿ÏÎ¬Ï‚)</span>
                    <span id="r-dirty-cost" class="result-value">-</span>
                </div>
                <div class="result-row total">
                    <span class="result-label">ÎšÎ­ÏÎ´Î¿Ï‚ / Î–Î·Î¼Î¯Î± ÏƒÏ„Î· Î›Î®Î¾Î·/ Profit/Loss at Maturity </span>
                    <span id="r-profit" class="result-value">-</span>
                </div>
            </div>

            <h3 style="margin-top: 25px; color: #37474f;">ğŸ’° Î‘Î½Î±Î»Ï…Ï„Î¹ÎºÎ­Ï‚ Î¤Î±Î¼ÎµÎ¹Î±ÎºÎ­Ï‚ Î¡Î¿Î­Ï‚</h3>
            <table>
                <thead>
                    <tr>
                        <th>Î ÎµÏÎ¯Î¿Î´Î¿Ï‚</th>
                        <th>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th>
                        <th>Î—Î¼Î­ÏÎµÏ‚</th>
                        <th>ÎšÎ¿Ï…Ï€ÏŒÎ½Î¹ (â‚¬)</th>
                        <th>ÎšÎµÏ†Î¬Î»Î±Î¹Î¿ (â‚¬)</th>
                        <th>Î£ÏÎ½Î¿Î»Î¿ (â‚¬)</th>
                    </tr>
                </thead>
                <tbody id="tb"></tbody>
            </table>

            <div class="verification">
                <strong>âœ“ Î•Ï€Î±Î»Î®Î¸ÎµÏ…ÏƒÎ·:</strong> Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î­Î½Î· Î Î±ÏÎ¿ÏÏƒÎ± Î‘Î¾Î¯Î± = <span id="r-pv">-</span>
                <br>Î”Î¹Î±Ï†Î¿ÏÎ¬ Î±Ï€ÏŒ Market Value: <span id="r-diff">-</span>
            </div>

            <button class="btn-export" onclick="exportTXT()">ğŸ“„ Î•Î¾Î±Î³Ï‰Î³Î® TXT</button>
        </div>
    </div>

    <script>
        // ============================================
        // Î•Î›Î›Î—ÎÎ™ÎšÎ— ÎœÎŸÎ¡Î¦ÎŸÎ ÎŸÎ™Î—Î£Î—
        // ============================================

        function fmt(num) {
            let n = Number(num);
            if (isNaN(n)) return '0,00';
            let str = n.toFixed(2);
            let parts = str.split('.');
            let intPart = parts[0];
            let decPart = parts[1];
            let res = '';
            let cnt = 0;
            for (let i = intPart.length - 1; i >= 0; i--) {
                res = intPart[i] + res;
                cnt++;
                if (cnt === 3 && i > 0) {
                    res = '.' + res;
                    cnt = 0;
                }
            }
            return res + ',' + decPart;
        }

        function fmtDate(d) {
            if (typeof d === 'string') d = new Date(d);
            if (!d || isNaN(d.getTime())) return '';
            return String(d.getDate()).padStart(2, '0') + '/' + 
                   String(d.getMonth() + 1).padStart(2, '0') + '/' + 
                   d.getFullYear();
        }

        function par(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/\./g, '').replace(',', '.'));
        }

        function days(s, e) {
            return Math.round((e - s) / (24 * 60 * 60 * 1000));
        }

        // ÎÎ•ÎŸ: Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î´Î¹Î¬ÏÎºÎµÎ¹Î±Ï‚ ÏƒÎµ Ï‡ÏÏŒÎ½Î¹Î±
        function calcDurationYears(start, end) {
            let d1 = new Date(start);
            let d2 = new Date(end);
            
            let years = d2.getFullYear() - d1.getFullYear();
            let months = d2.getMonth() - d1.getMonth();
            let days = d2.getDate() - d1.getDate();
            
            // Î”Î¹ÏŒÏÎ¸Ï‰ÏƒÎ· Î±Î½ Î¿Î¹ Î¼Î­ÏÎµÏ‚ ÎµÎ¯Î½Î±Î¹ Î±ÏÎ½Î·Ï„Î¹ÎºÎ­Ï‚
            if (days < 0) {
                months--;
                // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î·Î¼ÎµÏÏÎ½ Ï„Î¿Ï… Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿Ï… Î¼Î®Î½Î±
                let prevMonth = new Date(d2.getFullYear(), d2.getMonth(), 0);
                days += prevMonth.getDate();
            }
            
            // Î”Î¹ÏŒÏÎ¸Ï‰ÏƒÎ· Î±Î½ Î¿Î¹ Î¼Î®Î½ÎµÏ‚ ÎµÎ¯Î½Î±Î¹ Î±ÏÎ½Î·Ï„Î¹ÎºÎ¿Î¯
            if (months < 0) {
                years--;
                months += 12;
            }
            
            // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÎºÎ»Î±ÏƒÎ¼Î±Ï„Î¹ÎºÏÎ½ ÎµÏ„ÏÎ½
            let fractionalYears = years + (months / 12) + (days / 365.25);
            
            return {
                years: years,
                months: months,
                days: days,
                totalYears: fractionalYears
            };
        }

        // AUTO-FORMATTING Î³Î¹Î± Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚ (ÎµÎºÏ„ÏŒÏ‚ Î±Ï€ÏŒ ÎµÏ€Î¹Ï„ÏŒÎºÎ¹Î¿)
        document.getElementById('fv').addEventListener('blur', function() {
            let val = this.value.trim().replace(/\s/g, '');
            if (val) {
                let clean = val.replace(/\./g, '').replace(',', '.');
                let num = parseFloat(clean);
                if (!isNaN(num) && num !== 0) {
                    this.value = fmt(num);
                }
            }
        });
        
        document.getElementById('mv').addEventListener('blur', function() {
            let val = this.value.trim().replace(/\s/g, '');
            if (val) {
                let clean = val.replace(/\./g, '').replace(',', '.');
                let num = parseFloat(clean);
                if (!isNaN(num) && num !== 0) {
                    this.value = fmt(num);
                }
            }
        });

        // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÎºÎ¿Ï…Ï€Î¿Î½Î¹ÏÎ½ Î±Ï€ÏŒ Î»Î®Î¾Î·
        function getCoupons(issue, maturity, freq) {
            let coupons = [];
            let cur = new Date(maturity);
            while (cur > issue) {
                coupons.unshift(new Date(cur));
                cur.setMonth(cur.getMonth() - freq);
            }
            return coupons;
        }

        // Newton-Raphson Î³Î¹Î± YTM
        function calcYTM(price, face, couponPay, periods, periodsPerYear, firstFrac) {
            let r = 0.05 / periodsPerYear;
            for (let i = 0; i < 100; i++) {
                let pvCoupons = 0;
                for (let t = 1; t <= periods; t++) {
                    pvCoupons += couponPay / Math.pow(1 + r, t - 1 + firstFrac);
                }
                let pvFace = face / Math.pow(1 + r, periods - 1 + firstFrac);
                let f = pvCoupons + pvFace - price;
                
                let df = 0;
                for (let t = 1; t <= periods; t++) {
                    df -= (t - 1 + firstFrac) * couponPay / Math.pow(1 + r, t + firstFrac);
                }
                df -= (periods - 1 + firstFrac) * face / Math.pow(1 + r, periods + firstFrac);
                
                if (Math.abs(df) < 1e-10) break;
                let rNew = r - f / df;
                if (Math.abs(rNew - r) < 1e-10) {
                    r = rNew;
                    break;
                }
                r = rNew;
                if (r < -0.99) r = -0.99;
            }
            return r * periodsPerYear * 100;
        }

        let lastCalc = null;

        function calculate() {
            try {
                // Î”Î¹Î¬Î²Î±ÏƒÎµ inputs
                let fv = par(document.getElementById('fv').value);
                let mv = par(document.getElementById('mv').value);
                let crStr = document.getElementById('cr').value.trim();
                let cr = parseFloat(crStr.replace(',', '.'));
                
                let id = new Date(document.getElementById('id').value);
                let vd = new Date(document.getElementById('vd').value);
                let md = new Date(document.getElementById('md').value);
                let fr = parseInt(document.getElementById('fr').value);
                let db = parseInt(document.getElementById('db').value);

                // Validation
                if (isNaN(id.getTime()) || isNaN(vd.getTime()) || isNaN(md.getTime())) {
                    alert('Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯ÎµÏ‚!');
                    return;
                }
                if (md <= id) {
                    alert('Î— Î»Î®Î¾Î· Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Î¼ÎµÏ„Î¬ Ï„Î·Î½ Î­ÎºÎ´Î¿ÏƒÎ·!');
                    return;
                }
                if (vd < id || vd > md) {
                    alert('Î— Î±Î³Î¿ÏÎ¬ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Î¼ÎµÏ„Î±Î¾Ï Î­ÎºÎ´Î¿ÏƒÎ·Ï‚ ÎºÎ±Î¹ Î»Î®Î¾Î·Ï‚!');
                    return;
                }

                // ÎÎ•ÎŸ: Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î´Î¹Î¬ÏÎºÎµÎ¹Î±Ï‚
                let duration = calcDurationYears(vd, md);

                // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ÎºÎ¿Ï…Ï€Î¿Î½Î¹ÏÎ½
                let allCoupons = getCoupons(id, md, fr);
                let lastC = id;
                let future = [];
                
                for (let d of allCoupons) {
                    if (d <= vd) lastC = d;
                    else future.push(d);
                }

                if (future.length === 0) {
                    alert('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î¼ÎµÎ»Î»Î¿Î½Ï„Î¹ÎºÎ¬ ÎºÎ¿Ï…Ï€ÏŒÎ½Î¹Î±!');
                    return;
                }

                // Î’Î±ÏƒÎ¹ÎºÎ¿Î¯ Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Î¯
                let ppy = 12 / fr;
                let ann = fv * (cr / 100);
                let cp = ann / ppy;
                let accDays = days(lastC, vd);
                let acc = ann * accDays / db;
                let dirty = mv + acc;
                
                let nextC = future[0];
                let daysToNext = days(vd, nextC);
                let daysFull = days(lastC, nextC);
                if (daysFull === 0) daysFull = db / ppy;
                let frac = daysToNext / daysFull;
                
                let ytm = calcYTM(mv, fv, cp, future.length, ppy, frac);

                // Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ Î£Î¥ÎÎŸÎ›Î©Î
                let totalCoupons = cp * future.length;
                let totalCashFlows = totalCoupons + fv;
                let profitLoss = totalCashFlows - dirty;

                lastCalc = {
                    fv, mv, cr, id, vd, md, fr, db, ytm, acc, dirty, accDays,
                    ann, future, cp, daysToNext, daysFull, lastC, nextC,
                    totalCoupons, totalCashFlows, profitLoss, duration
                };

                // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î²Î±ÏƒÎ¹ÎºÏÎ½ Î±Ï€Î¿Ï„ÎµÎ»ÎµÏƒÎ¼Î¬Ï„Ï‰Î½
                document.getElementById('r-ytm').textContent = ytm.toFixed(4) + '%';
                document.getElementById('r-acc').textContent = 'â‚¬' + fmt(acc);
                document.getElementById('r-dirty').textContent = 'â‚¬' + fmt(dirty);
                document.getElementById('r-days').textContent = accDays + ' Î·Î¼Î­ÏÎµÏ‚';
                document.getElementById('r-ann').textContent = 'â‚¬' + fmt(ann);
                
                // ÎÎ•ÎŸ: Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î´Î¹Î¬ÏÎºÎµÎ¹Î±Ï‚
                let durationText = duration.years + ' Î­Ï„Î·, ' + duration.months + ' Î¼Î®Î½ÎµÏ‚, ' + duration.days + ' Î·Î¼Î­ÏÎµÏ‚';
                durationText += ' (' + duration.totalYears.toFixed(2) + ' Ï‡ÏÏŒÎ½Î¹Î±)';
                document.getElementById('r-duration').textContent = durationText;

                // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î£Î¥ÎÎŸÎ›Î©Î
                document.getElementById('r-tot-coup').textContent = 'â‚¬' + fmt(totalCoupons);
                document.getElementById('r-cap').textContent = 'â‚¬' + fmt(fv);
                document.getElementById('r-tot-all').textContent = 'â‚¬' + fmt(totalCashFlows);
                document.getElementById('r-dirty-cost').textContent = 'â‚¬' + fmt(dirty);
                
                let profitElem = document.getElementById('r-profit');
                profitElem.textContent = (profitLoss >= 0 ? '+' : '') + 'â‚¬' + fmt(profitLoss);
                profitElem.style.color = profitLoss >= 0 ? '#28a745' : '#dc3545';

                // Î Î¯Î½Î±ÎºÎ±Ï‚ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÏÎ½ Ï„Î±Î¼ÎµÎ¹Î±ÎºÏÎ½ ÏÎ¿ÏÎ½
                let tb = document.getElementById('tb');
                tb.innerHTML = '';
                let prev = vd;

                for (let i = 0; i < future.length; i++) {
                    let d = future[i];
                    let ds = days(prev, d);
                    let isLast = i === future.length - 1;
                    let pr = isLast ? fv : 0;
                    let tot = cp + pr;

                    let row = tb.insertRow();
                    row.innerHTML = '<td>' + (i+1) + '</td>' +
                                    '<td>' + fmtDate(d) + '</td>' +
                                    '<td>' + ds + '</td>' +
                                    '<td>â‚¬' + fmt(cp) + '</td>' +
                                    '<td>â‚¬' + fmt(pr) + '</td>' +
                                    '<td>â‚¬' + fmt(tot) + '</td>';
                    prev = d;
                }

                // Î•Ï€Î±Î»Î®Î¸ÎµÏ…ÏƒÎ·
                let r = ytm / 100 / ppy;
                let pv = 0;
                for (let i = 0; i < future.length; i++) {
                    let cf = i === future.length - 1 ? cp + fv : cp;
                    pv += cf / Math.pow(1 + r, i + frac);
                }
                document.getElementById('r-pv').textContent = 'â‚¬' + fmt(pv);
                document.getElementById('r-diff').textContent = 'â‚¬' + fmt(Math.abs(pv - mv));

                document.getElementById('res').classList.add('show');
                document.getElementById('res').scrollIntoView({ behavior: 'smooth' });

            } catch (e) {
                alert('Î£Ï†Î¬Î»Î¼Î±: ' + e.message);
                console.error(e);
            }
        }

        function exportTXT() {
            if (!lastCalc) {
                alert('ÎšÎ¬Î½Ï„Îµ Ï€ÏÏÏ„Î± Ï…Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒ!');
                return;
            }
            let c = lastCalc;
            let out = '='.repeat(80) + '\n';
            out += 'Î‘ÎÎ‘Î›Î¥Î£Î— ÎŸÎœÎŸÎ›ÎŸÎ“ÎŸÎ¥\n';
            out += '='.repeat(80) + '\n\n';
            out += 'Î£Î¤ÎŸÎ™Î§Î•Î™Î‘ ÎŸÎœÎŸÎ›ÎŸÎ“ÎŸÎ¥\n';
            out += '-'.repeat(80) + '\n';
            out += 'ÎŸÎ½Î¿Î¼Î±ÏƒÏ„Î¹ÎºÎ® Î‘Î¾Î¯Î±:           â‚¬' + fmt(c.fv) + '\n';
            out += 'Market Value (Clean Price): â‚¬' + fmt(c.mv) + '\n';
            out += 'Î ÏÎ¿Ï€Î»Î·ÏÏ‰Î¼Î­Î½Î¿ ÎšÎ¿Ï…Ï€ÏŒÎ½Î¹:      â‚¬' + fmt(c.acc) + '\n';
            out += 'ÎœÎ¹ÎºÏ„Î® Î¤Î¹Î¼Î® (Dirty Price):   â‚¬' + fmt(c.dirty) + '\n';
            out += '-'.repeat(80) + '\n';
            out += 'Î•Ï€Î¹Ï„ÏŒÎºÎ¹Î¿ ÎšÎ¿Ï…Ï€Î¿Î½Î¹Î¿Ï:         ' + c.cr + '%\n';
            out += 'YTM:                        ' + c.ytm.toFixed(4) + '%\n';
            out += 'Î£Ï…Ï‡Î½ÏŒÏ„Î·Ï„Î±:                  ' + (12/c.fr) + ' Ï†Î¿ÏÎ­Ï‚/Î­Ï„Î¿Ï‚\n';
            out += 'Î’Î¬ÏƒÎ· Î—Î¼ÎµÏÏÎ½:                ' + c.db + '\n';
            out += '-'.repeat(80) + '\n';
            out += 'Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÎˆÎºÎ´Î¿ÏƒÎ·Ï‚:         ' + fmtDate(c.id) + '\n';
            out += 'Value Day / Î‘Î³Î¿ÏÎ¬Ï‚:         ' + fmtDate(c.vd) + '\n';
            out += 'Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î›Î®Î¾Î·Ï‚:           ' + fmtDate(c.md) + '\n';
            out += 'Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ ÎšÎ¿Ï…Ï€ÏŒÎ½Î¹:          ' + fmtDate(c.lastC) + '\n';
            out += 'Î•Ï€ÏŒÎ¼ÎµÎ½Î¿ ÎšÎ¿Ï…Ï€ÏŒÎ½Î¹:            ' + fmtDate(c.nextC) + '\n';
            out += 'Î—Î¼Î­ÏÎµÏ‚ Accrued:             ' + c.accDays + '\n';
            out += 'Î—Î¼Î­ÏÎµÏ‚ Î­Ï‰Ï‚ Î•Ï€ÏŒÎ¼ÎµÎ½Î¿:         ' + c.daysToNext + '\n';
            // ÎÎ•ÎŸ: Î”Î¹Î¬ÏÎºÎµÎ¹Î± ÏƒÏ„Î¿ export
            out += 'Î”Î¹Î¬ÏÎºÎµÎ¹Î± ÎŸÎ¼Î¿Î»ÏŒÎ³Î¿Ï…:          ' + c.duration.years + ' Î­Ï„Î·, ' + c.duration.months + ' Î¼Î®Î½ÎµÏ‚, ' + c.duration.days + ' Î·Î¼Î­ÏÎµÏ‚ (' + c.duration.totalYears.toFixed(2) + ' Ï‡ÏÏŒÎ½Î¹Î±)\n';
            out += 'Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ Î ÎµÏÎ¯Î¿Î´Î¿Î¹:         ' + c.future.length + '\n';
            out += '-'.repeat(80) + '\n\n';
            
            // Î£Î¥ÎÎŸÎ›Î‘
            out += 'Î£Î¥ÎÎŸÎ›Î™ÎšÎ•Î£ Î¤Î‘ÎœÎ•Î™Î‘ÎšÎ•Î£ Î¡ÎŸÎ•Î£\n';
            out += '-'.repeat(80) + '\n';
            out += 'Î£ÏÎ½Î¿Î»Î¿ ÎšÎ¿Ï…Ï€Î¿Î½Î¹ÏÎ½:           â‚¬' + fmt(c.totalCoupons) + '\n';
            out += 'ÎšÎµÏ†Î¬Î»Î±Î¹Î¿ Î›Î®Î¾Î·Ï‚:             â‚¬' + fmt(c.fv) + '\n';
            out += 'Î£Î¥ÎÎŸÎ›Î™ÎšÎ•Î£ Î•Î™Î£Î Î¡Î‘ÎÎ•Î™Î£:       â‚¬' + fmt(c.totalCashFlows) + '\n';
            out += 'ÎœÎ¹ÎºÏ„Î® Î¤Î¹Î¼Î® (ÎšÏŒÏƒÏ„Î¿Ï‚):        â‚¬' + fmt(c.dirty) + '\n';
            out += 'ÎšÎ­ÏÎ´Î¿Ï‚ / Î–Î·Î¼Î¯Î± ÏƒÏ„Î· Î›Î®Î¾Î·:    â‚¬' + fmt(c.profitLoss) + '\n';
            out += '-'.repeat(80) + '\n\n';
            
            out += 'Î‘ÎÎ‘Î›Î¥Î¤Î™ÎšÎ•Î£ Î¤Î‘ÎœÎ•Î™Î‘ÎšÎ•Î£ Î¡ÎŸÎ•Î£\n';
            out += '='.repeat(80) + '\n';
            out += 'Î ÎµÏ  Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±      Î—Î¼Î­ÏÎµÏ‚  ÎšÎ¿Ï…Ï€ÏŒÎ½Î¹        ÎšÎµÏ†Î¬Î»Î±Î¹Î¿       Î£ÏÎ½Î¿Î»Î¿\n';
            out += '-'.repeat(80) + '\n';
            
            let prev = c.vd;
            for (let i = 0; i < c.future.length; i++) {
                let d = c.future[i];
                let ds = days(prev, d);
                let isLast = i === c.future.length - 1;
                let pr = isLast ? c.fv : 0;
                let tot = c.cp + pr;
                out += (i+1).toString().padEnd(4) + ' ' +
                       fmtDate(d).padEnd(15) + ' ' +
                       ds.toString().padEnd(7) + ' â‚¬' +
                       fmt(c.cp).padEnd(14) + ' â‚¬' +
                       fmt(pr).padEnd(14) + ' â‚¬' +
                       fmt(tot) + '\n';
                prev = d;
            }
            out += '='.repeat(80) + '\n';

            let blob = new Blob([out], { type: 'text/plain;charset=utf-8' });
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = 'bond_' + fmtDate(new Date()).replace(/\//g, '-') + '.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Defaults
        let t = new Date();
        document.getElementById('id').valueAsDate = t;
        document.getElementById('vd').valueAsDate = t;
        let f = new Date(t);
        f.setFullYear(f.getFullYear() + 7);
        document.getElementById('md').valueAsDate = f;
    </script>
</body>
</html>
